{% extends "contracts/base_contracts.html" %}
{% load contracts_extras %}

{% block contracts_content %}
<!-- Header -->
<div class="contracts-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>Settings</h1>
            <p class="text-muted mb-0 small">Manage contract types, tags, departments, and clauses</p>
        </div>
    </div>
</div>

<div class="p-4">
    <div class="row g-4">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3">
            <div class="config-nav">
                <button class="config-nav-item active" data-target="#types">
                    <i class="bi bi-file-earmark-text"></i>
                    <div class="config-nav-content">
                        <span class="config-nav-title">Contract Types</span>
                        <span class="config-nav-count">{{ contract_types|length }}</span>
                    </div>
                </button>
                <button class="config-nav-item" data-target="#tags">
                    <i class="bi bi-tags"></i>
                    <div class="config-nav-content">
                        <span class="config-nav-title">Tags</span>
                        <span class="config-nav-count">{{ tags|length }}</span>
                    </div>
                </button>
                <button class="config-nav-item" data-target="#departments">
                    <i class="bi bi-building"></i>
                    <div class="config-nav-content">
                        <span class="config-nav-title">Departments</span>
                        <span class="config-nav-count">{{ departments|length }}</span>
                    </div>
                </button>
                <button class="config-nav-item" data-target="#playbook">
                    <i class="bi bi-book"></i>
                    <div class="config-nav-content">
                        <span class="config-nav-title">Clause Playbook</span>
                        <span class="config-nav-count">{{ playbook_entries|length }}</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="col-lg-9">
            <!-- Contract Types -->
            <div class="config-panel active" id="types">
                <div class="content-card">
                    <div class="card-header">
                        <span>Contract Types</span>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTypeModal">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                    {% if contract_types %}
                    <div class="config-list">
                        {% for type in contract_types %}
                        <div class="config-list-item">
                            <div class="config-list-info">
                                <div class="fw-medium">{{ type.name }}</div>
                                <div class="text-muted small">{{ type.description|truncatechars:60|default:"No description" }}</div>
                            </div>
                            <div class="config-list-actions">
                                {% if type.active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                                <form method="post" action="{% url 'contracts:config_type_delete' pk=type.pk %}"
                                      onsubmit="return confirm('Delete this contract type?');" class="d-inline ms-2">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-muted p-0">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-text text-muted" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No contract types defined</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tags -->
            <div class="config-panel" id="tags">
                <div class="content-card">
                    <div class="card-header">
                        <span>Tags</span>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                    {% if tags %}
                    <div class="config-list">
                        {% for tag in tags %}
                        <div class="config-list-item">
                            <div class="config-list-info">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="color-dot" style="background: {{ tag.color }};"></span>
                                    <span class="fw-medium">{{ tag.name }}</span>
                                </div>
                                <div class="text-muted small">{{ tag.description|truncatechars:50|default:"No description" }}</div>
                            </div>
                            <div class="config-list-actions">
                                {% if tag.active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                                <form method="post" action="{% url 'contracts:config_tag_delete' pk=tag.pk %}"
                                      onsubmit="return confirm('Delete this tag?');" class="d-inline ms-2">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-muted p-0">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-tags text-muted" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No tags defined</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Departments -->
            <div class="config-panel" id="departments">
                <div class="content-card">
                    <div class="card-header">
                        <span>Departments</span>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addDeptModal">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                    {% if departments %}
                    <div class="config-list">
                        {% for dept in departments %}
                        <div class="config-list-item">
                            <div class="config-list-info">
                                <div class="fw-medium">{{ dept.name }}</div>
                                <div class="text-muted small">{{ dept.contracts.count }} contracts</div>
                            </div>
                            <div class="config-list-actions">
                                <form method="post" action="{% url 'contracts:config_dept_delete' pk=dept.pk %}"
                                      onsubmit="return confirm('Delete this department?');" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-muted p-0">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-building text-muted" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No departments defined</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Clause Playbook -->
            <div class="config-panel" id="playbook">
                <div class="content-card">
                    <div class="card-header">
                        <span>Clause Playbook</span>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClauseModal">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                    {% if playbook_entries %}
                    <div class="config-list">
                        {% for entry in playbook_entries %}
                        <div class="config-list-item">
                            <div class="config-list-info" style="flex: 1;">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="fw-medium">{{ entry.label }}</span>
                                    {{ entry.risk_level|risk_badge }}
                                </div>
                                <div class="text-muted small">{{ entry.recommended_text|truncatechars:80 }}</div>
                            </div>
                            <div class="config-list-actions">
                                {% if entry.active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                                <form method="post" action="{% url 'contracts:config_clause_delete' pk=entry.pk %}"
                                      onsubmit="return confirm('Delete this clause?');" class="d-inline ms-2">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-muted p-0">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-book text-muted" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No clauses in playbook</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add Contract Type Modal -->
<div class="modal fade" id="addTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'contracts:config_type_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Contract Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="active" class="form-check-input" id="typeActive" checked>
                        <label class="form-check-label" for="typeActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Type</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'contracts:config_tag_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" name="color" class="form-control form-control-color" value="#059669" style="height: 38px;">
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="active" class="form-check-input" id="tagActive" checked>
                        <label class="form-check-label" for="tagActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Tag</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDeptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'contracts:config_dept_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Department</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Clause Modal -->
<div class="modal fade" id="addClauseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'contracts:config_clause_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Clause to Playbook</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Label</label>
                            <input type="text" name="label" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <input type="text" name="category" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Recommended Text</label>
                            <textarea name="recommended_text" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Risk Level</label>
                            <select name="risk_level" class="form-select">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="active" class="form-check-input" id="clauseActive" checked>
                                <label class="form-check-label" for="clauseActive">Active</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Guidance Notes</label>
                            <textarea name="guidance_notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Clause</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Config Navigation */
.config-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.config-nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
    width: 100%;
}

.config-nav-item:hover {
    border-color: var(--primary);
}

.config-nav-item.active {
    background: var(--primary-light);
    border-color: var(--primary);
}

.config-nav-item i {
    font-size: 1.125rem;
    color: var(--text-muted);
    width: 24px;
    text-align: center;
}

.config-nav-item.active i {
    color: var(--primary);
}

.config-nav-content {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.config-nav-title {
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
}

.config-nav-item.active .config-nav-title {
    color: var(--primary);
}

.config-nav-count {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Config Panels */
.config-panel {
    display: none;
}

.config-panel.active {
    display: block;
}

/* Config List */
.config-list {
    padding: 0;
}

.config-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-light);
}

.config-list-item:last-child {
    border-bottom: none;
}

.config-list-item:hover {
    background: var(--bg-main);
}

.config-list-info {
    flex: 1;
    min-width: 0;
}

.config-list-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.config-nav-item');
    const panels = document.querySelectorAll('.config-panel');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove active from all
            navItems.forEach(n => n.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            
            // Add active to clicked
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            document.querySelector(targetId).classList.add('active');
        });
    });
});
</script>
{% endblock %}
